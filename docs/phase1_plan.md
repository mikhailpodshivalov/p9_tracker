# Этап 1: План первоначальной разработки `p9_tracker`

## Статус этапа

- Статус: `Completed (planning artifacts prepared)`
- Решение по стеку: `Rust` (см. `docs/adr/ADR-0001-tech-stack-rust.md`)
- Артефакты этапа: `docs/architecture_v0.md`, `docs/data_contracts_v0.md`, `docs/risk_register_v0.md`, `docs/week1_backlog.md`

## Краткое резюме

- Репозиторий сейчас в состоянии `greenfield`: есть только `README.md`, технический фундамент отсутствует.
- Этап 1 должен завершиться не кодом, а зафиксированными решениями: scope, архитектура, контракты данных, риски, недельный backlog.
- Главный фокус — снизить риск неверного старта realtime-аудио части: чётко разделить `UI`/`Scheduler`/`Audio RT`.
- До начала реализации нужно зафиксировать Definition of Done и критический путь первой недели.
- Для старта достаточно `контрактов v0` и архитектурных интерфейсов на уровне документации.
- Риски realtime, формата проекта и недетерминированности должны быть проверяемыми уже на первой неделе.
- Готовность к этапу 2 определяется наличием согласованного плана, приоритизированного backlog и критериев проверки.

## 1) Аудит текущего состояния репозитория

### Что уже есть

- Инициализирован git-репозиторий на ветке `main`.
- Есть один коммит (`first commit`).
- Единственный файл проекта: `README.md` с заголовком `# p9_tracker`.

### Пустые места

- Нет структуры каталогов (`docs/`, `engine/`, `ui/`, `tests/` и т.д.).
- Нет архитектурных документов и решений (ADR).
- Нет зафиксированного scope MVP.
- Нет формата проектных данных.
- Нет плана рисков и критериев качества.
- Нет backlog и оценки задач.

### Что критически отсутствует для старта

- Документированная архитектура компонентов и потоков данных.
- Контракты данных v0 для сущностей трекера.
- Стратегия realtime-безопасности (что запрещено в RT-аудио потоке).
- Проверяемый план первой недели с зависимостями.

### Вывод: готовность к этапу 2

- Текущее состояние: **не готов** к этапу 2 (реализации).
- После выполнения данного Этапа 1: **готов**, если выполнен DoD из раздела 2.

## 2) Scope Этапа 1 (границы)

### Входит в Этап 1 (обязательно сейчас)

- Аудит репозитория и фиксация стартового baseline.
- Формализация scope (что делаем/не делаем).
- Архитектурный черновик компонентов и потоков.
- Контракты данных v0.
- Топ-10 рисков + способ проверки/снижения.
- Детальный план первой недели.
- Backlog с приоритетом, оценкой, зависимостями и критическим путём.

### Не входит в Этап 1 (позже)

- Написание исходного кода.
- Настройка сборки/CI/линтеров.
- Реализация DSP, UI или MIDI.
- Реальные тесты производительности/латентности на коде.

### Definition of Done (Этап 1 завершён)

- Есть единый документ с разделами 1→7.
- Для каждой области определены `сейчас` и `позже`.
- Контракты данных v0 описаны явно и без противоречий.
- Для каждого из 10 рисков есть проверка и стратегия снижения.
- Есть недельный план с артефактами по дням.
- Есть backlog с `P0/P1/P2`, оценкой в часах и выделенным критическим путём.

## 3) Архитектурный черновик (без реализации)

### Компоненты

- `UI`: редакторы song/chain/phrase/instrument/table/mix, пользовательский ввод, отображение состояния.
- `Engine`: доменная логика трекера, обработка команд редактирования, валидация данных.
- `Scheduler`: музыкальный таймбейс (`ticks/PPQ`), порядок исполнения событий, подготовка событий для аудио.
- `Audio`: realtime рендер, микс, master chain, вывод.
- `MIDI`: вход/выход MIDI, clock/transport, трансляция событий в scheduler.
- `Storage`: загрузка/сохранение проекта, версии формата, рендер в файл.
- `DSP/FX`: инструменты, send/master эффекты, обработка сигнала.

### Потоки данных

1. `UI -> Engine`: команды пользователя (редактирование/навигация).
2. `Engine -> Scheduler`: изменения структуры песни и событий воспроизведения.
3. `Scheduler -> Audio`: подготовленные события на аудио-блок.
4. `MIDI -> Scheduler/Engine`: ноты/clock/transport и команды управления.
5. `Audio -> UI`: metering и snapshots состояния (только чтение для UI).
6. `Engine <-> Storage`: сериализация/десериализация проекта и метаданных.

### Потокобезопасность и realtime-ограничения

- RT-аудио поток: `no malloc`, `no locks`, `no file IO`, `no blocking logging`.
- Межпоточная передача: lock-free очереди и snapshot-модель состояния.
- UI не изменяет DSP/Audio состояние напрямую; только через команды в Engine/Scheduler.
- Детерминированность: фиксированный порядок обработки событий в пределах тика.

## 4) Контракты данных v0

### Минимальный состав сущностей и связей

- `Song` содержит 8 `Track`.
- `Track` ссылается на `Chain` по строкам song.
- `Chain` содержит последовательность `Phrase` (до 16 строк).
- `Phrase` содержит 16 шагов: `Note`, `Velocity`, `Instrument`, `FX1..FX3`.
- `Instrument` может использовать `Table` и маршрутизируется в `Mixer`.
- `Table` содержит шаговые модификации и FX-команды.
- `Groove` задаёт длительность шагов (ticks).
- `Scale` задаёт тональность/квантизацию.
- `Mixer` управляет уровнями/посылами/мастером.
- `FX` — командный слой автоматизации/изменений параметров.

### Обязательные поля v0

- `Song`: `name`, `tempo`, `default_groove`, `default_scale`.
- `Track`: `index`, `song_rows[]` (ссылки на chain), `mute`, `solo`.
- `Chain`: `id`, `rows[]` (phrase refs + transpose).
- `Phrase`: `id`, `steps[16]`.
- `Step`: `note`, `velocity`, `instrument_id`, `fx[3]`.
- `Instrument`: `id`, `type`, `name`, `send_levels`, `table_id`.
- `Table`: `id`, `rows[16]`.
- `Groove`: `id`, `ticks_pattern`.
- `Scale`: `id`, `key`, `interval_mask`.
- `Mixer`: `track_levels[8]`, `master_level`, `send_levels`.

### Что отложить

- Расширенные modulation-режимы.
- Полный набор FX-команд и вероятностных сценариев.
- Продвинутые режимы live-performance.
- Расширенную экосистему файлов/тем/интеграций.

## 5) Риски и проверки (топ-10)

| # | Риск | Вероятность | Влияние | Проверка | Снижение |
|---|---|---|---|---|---|
| R1 | Неверная граница между UI и Audio RT | Высокая | Критичное | Архитектурный review потоков | Зафиксировать однонаправленный command pipeline |
| R2 | Недетерминированный scheduler | Средняя | Критичное | Таблица порядка исполнения событий | Формальный порядок событий по tick/step |
| R3 | Слишком широкий MVP scope | Высокая | Высокое | Сверка backlog vs MVP таблица | Жёсткий freeze P0 и defer P1/P2 |
| R4 | Нестабильный формат данных при ранних изменениях | Средняя | Высокое | Ревью схемы `v0` | Версионирование формата с миграциями |
| R5 | Переоценка скорости соло-разработки | Высокая | Высокое | Еженедельный контроль burn rate | Бить задачи на 4–8 часов |
| R6 | Недостаточная покрываемость рисков тест-кейсами | Средняя | Высокое | Матрица «риск -> проверка» | Включить проверки в DoD задач |
| R7 | Непрозрачные зависимости задач | Средняя | Среднее | Критический путь в backlog | Явные dependency поля |
| R8 | Размытые критерии “готово” | Средняя | Среднее | Проверка каждой задачи на acceptance criteria | Шаблон DoD для каждой P0 |
| R9 | Нет дисциплины по токенам/итерациям | Средняя | Среднее | Недельный лимит и отчёт по итерациям | Короткие батчи и узкие дифы |
| R10 | Ошибки приоритизации (сначала косметика) | Средняя | Среднее | Обзор приоритетов в начале недели | Сначала P0 по критическому пути |

### Отдельно: realtime-аудио риски

- RT-блокировки/алокации в аудио-потоке.
- Расхождение темпа/scheduler и аудио-таймбазы.
- XRUN при неконтролируемой сложности DSP.

Проверки на этапе планирования:

- Явный список RT-запретов.
- Явная схема очередей и ownership данных между потоками.
- Явная последовательность запуска: `scheduler contract -> audio contract -> DSP budget`.

## 6) План первой недели (день за днём)

| День | Задачи | Артефакт дня | Зависимости |
|---|---|---|---|
| День 1 | Уточнить scope, DoD, freeze границ этапа 1 | Разделы scope + DoD, согласованный baseline | Нет |
| День 2 | Зафиксировать архитектурный черновик компонентов и потоков | Диаграмма/описание компонентов и data flow | День 1 |
| День 3 | Сформировать контракты данных v0 | Таблица сущностей, связей и обязательных полей | День 2 |
| День 4 | Составить топ-10 рисков и матрицу проверок | Risk register с вероятностью/влиянием/mitigation | День 3 |
| День 5 | Подготовить backlog (P0/P1/P2), оценить часы, выделить критический путь | Backlog таблица + критический путь | День 4 |
| День 6 | Сверить недельный план с рисками и DoD, убрать противоречия | Финальная ревизия плана этапа 1 | День 5 |
| День 7 | Финальное утверждение “готово к этапу 2” | Итоговый статус и стартовые задачи этапа 2 | День 6 |

## 7) Backlog Этапа 1

| ID | Описание | Приоритет | Оценка (часы) | Зависимость | Критерий готовности |
|---|---|---|---:|---|---|
| P1-001 | Зафиксировать границы этапа 1 и DoD | P0 | 3 | — | Есть явный список in/out и DoD |
| P1-002 | Описать архитектурные компоненты и ответственность | P0 | 4 | P1-001 | Есть раздел компонентной модели |
| P1-003 | Зафиксировать потоки данных между компонентами | P0 | 4 | P1-002 | Есть сквозной flow UI->Engine->Scheduler->Audio |
| P1-004 | Зафиксировать RT-ограничения и модель потокобезопасности | P0 | 3 | P1-003 | Есть список RT-запретов и механизм обмена |
| P1-005 | Подготовить контракты данных v0 по сущностям | P0 | 5 | P1-002 | Есть таблица сущностей/полей/связей |
| P1-006 | Определить, что отложено на later (defer list) | P1 | 2 | P1-005 | Есть явный список deferred областей |
| P1-007 | Собрать риск-регистр топ-10 | P0 | 4 | P1-003, P1-005 | Для каждого риска есть вероятность/влияние/mitigation |
| P1-008 | Выделить отдельно realtime риски и проверки | P0 | 2 | P1-007 | Есть отдельный раздел RT-рисков |
| P1-009 | Сформировать недельный план с зависимостями | P0 | 3 | P1-007 | Есть day-by-day план и артефакты |
| P1-010 | Сформировать backlog P0/P1/P2 с оценкой | P0 | 3 | P1-009 | Есть таблица задач с оценками и зависимостями |
| P1-011 | Выделить критический путь этапа 1 | P0 | 1 | P1-010 | Критический путь явно отмечен |
| P1-012 | Финальная консолидация и статус готовности к этапу 2 | P0 | 2 | P1-011 | Документ целостен, противоречий нет |

### Критический путь

`P1-001 -> P1-002 -> P1-003 -> P1-004 -> P1-005 -> P1-007 -> P1-008 -> P1-009 -> P1-010 -> P1-011 -> P1-012`
